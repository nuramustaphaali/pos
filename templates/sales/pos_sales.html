{% extends 'core/base.html' %}
{% load static %}

{% block title %}POS Terminal - SwiftPOS{% endblock %}

{% block topbar_title %}
POS Terminal
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Order + cashier overview -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0" style="background: radial-gradient(circle at top left, rgba(79,70,229,.18), transparent 55%), radial-gradient(circle at bottom right, rgba(34,197,94,.14), transparent 45%), var(--sp-surface);">
                <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <div>
                        <div class="small text-muted mb-1">Active order</div>
                        <h5 class="mb-1">
                            <i class="fas fa-receipt me-2"></i>
                            {{ order.order_number }}
                        </h5>
                        <div class="small text-muted">
                            Cashier: {{ user_name }}
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="badge rounded-pill bg-light text-muted border">
                            <i class="fas fa-box-open me-1"></i>
                            <span id="itemCount">{{ order_items|length }}</span> item{{ order_items|length|pluralize }}
                        </span>
                        <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">
                            Total: <span class="ms-1 fw-semibold">₦{{ final_total|floatformat:2 }}</span>
                        </span>
                        <a href="{% url 'sales:daily_dashboard' %}" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2">
                            <i class="fas fa-chart-line"></i> Today’s summary
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main POS layout -->
    <div class="row g-3">
        <!-- LEFT: Products / search / quantity -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0 d-flex align-items-center gap-2">
                        <i class="fas fa-boxes-stacked"></i> Product Selection
                    </h6>
                    <span class="small text-muted">
                        Choose product & quantity, then add to cart
                    </span>
                </div>
                <div class="card-body">
                    <!-- Product select -->
                    <form method="post" id="productForm" class="mb-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_item">
                        <input type="hidden" name="quantity" id="quantityField" value="1">

                        <!-- Searchable Product Select -->
                        <div class="mb-3">
                            <label for="selectedProduct" class="form-label fw-semibold small">
                                Product
                            </label>
                            <select
                                class="form-select"
                                name="selected_product"
                                id="selectedProduct"
                                required>
                                <option value="">Search or choose product…</option>
                                {% for product in products %}
                                    <option
                                        value="{{ product.sku }}"
                                        data-name="{{ product.name }}"
                                        data-price="{{ product.price }}"
                                        data-stock="{{ product.stock_quantity }}">
                                        {{ product.name }} ({{ product.sku }}) - ₦{{ product.price }} | Stock: {{ product.stock_quantity }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text small text-muted">
                                Use SKU or name to quickly find items.
                            </div>
                        </div>

                        <!-- Quantity + quick add -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="quantityInput" class="form-label fw-semibold small">
                                    Quantity
                                </label>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="quantityInput"
                                    min="1"
                                    value="1"
                                    placeholder="Enter quantity">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small">
                                    Quick add
                                </label>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="quickAdd(1)">+1</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="quickAdd(5)">+5</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="quickAdd(10)">+10</button>
                                </div>
                            </div>
                        </div>

                        <!-- Selected product info + add to cart -->
                        <div class="mt-4 p-3 rounded-3" style="background:var(--sp-surface-muted);">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <div class="small text-muted mb-1">Selected product</div>
                                    <div class="small">
                                        Price: ₦<span id="selectedProductPrice">0.00</span> ·
                                        Stock: <span id="selectedProductStock">0</span>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary d-flex align-items-center gap-2" onclick="addToCart()">
                                        <i class="fas fa-cart-plus"></i>
                                        Add to cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Optional: instructions / tips -->
                    <!--<div class="mt-3 small text-muted">-->
                    <!--    Tip: keep the right side open on totals while the cashier adds items from here.-->
                    <!--</div>-->
                </div>
            </div>
        </div>

        <!-- RIGHT: Cart / totals / payment -->
        <div class="col-lg-4">
            <div class="position-sticky" style="top: 80px;">
                <!-- Cart items -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 d-flex align-items-center gap-2">
                            <i class="fas fa-shopping-basket"></i> Current Cart
                        </h6>
                        <span class="badge bg-light text-muted border small">
                            {{ order_items|length }} item{{ order_items|length|pluralize }}
                        </span>
                    </div>
                    <div class="card-body" style="max-height: calc(100vh - 320px); overflow-y: auto;" id="orderItemsContainer">
                        {% if order_items %}
                            {% for item in order_items %}
                                <div class="d-flex justify-content-between align-items-start mb-3 pb-2 border-bottom border-light-subtle">
                                    <div>
                                        <div class="fw-semibold small">{{ item.product.name }}</div>
                                        <div class="text-muted small">{{ item.product.sku }}</div>
                                        <div class="text-muted small">
                                            {{ item.quantity }} × ₦{{ item.unit_price }}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold small text-price">₦{{ item.total_price }}</div>
                                        <form method="post" class="mt-1">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="remove_item">
                                            <input type="hidden" name="item_id" value="{{ item.id }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted small mb-0 text-center">
                                No items in cart yet. Add products from the left panel.
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Totals -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small text-muted">Subtotal</span>
                            <span class="small">₦{{ subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small text-muted">Tax (0.0%)</span>
                            <span class="small">₦{{ tax_amount|floatformat:2 }}</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Total</span>
                            <span class="price text-success">₦{{ final_total|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>

                <!-- Payment -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0 d-flex align-items-center gap-2">
                            <i class="fas fa-wallet"></i> Payment
                        </h6>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="complete_order">

                            <div class="mb-3">
                                <label class="form-label small fw-semibold">Payment method</label>
                                <select class="form-select" name="payment_method" required>
                                    <option value="pos">POS / Card</option>
                                    <option value="transfer">Bank Transfer</option>
                                    <option value="cash">Cash</option>
                                    <option value="mobile_money">Mobile Money</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-semibold">Reference (optional)</label>
                                <input
                                    type="text"
                                    name="reference_number"
                                    class="form-control"
                                    placeholder="Transaction reference">
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-semibold">Customer Name (optional)</label>
                                <input
                                    type="text"
                                    name="customer_name"
                                    class="form-control"
                                    placeholder="Customer name">
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-semibold">Customer phone (optional)</label>
                                <input
                                    type="text"
                                    name="customer_phone"
                                    class="form-control"
                                    placeholder="Customer phone">
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary d-flex justify-content-center align-items-center gap-2">
                                    <i class="fas fa-check-circle"></i>
                                    Complete order
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Clear order -->
                <div class="card">
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="clear_order">
                            <button type="submit" class="btn btn-outline-danger w-100 d-flex justify-content-center align-items-center gap-2">
                                <i class="fas fa-trash"></i>
                                Clear order
                            </button>
                        </form>
                    </div>
                </div>

            </div> <!-- /position-sticky -->
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize Select2 on the product dropdown
    $('#selectedProduct').select2({
        placeholder: "Search or choose product…",
        allowClear: true,
        width: '100%',
        dropdownAutoWidth: true
    });

    const productSelect = document.getElementById('selectedProduct');
    const priceSpan = document.getElementById('selectedProductPrice');
    const stockSpan = document.getElementById('selectedProductStock');

    function updateSelectedInfo() {
        if (!productSelect || !priceSpan || !stockSpan) return;
        const opt = productSelect.options[productSelect.selectedIndex];
        if (opt && opt.value) {
            priceSpan.textContent = opt.dataset.price || '0.00';
            stockSpan.textContent = opt.dataset.stock || '0';
        } else {
            priceSpan.textContent = '0.00';
            stockSpan.textContent = '0';
        }
    }

    if (productSelect) {
        productSelect.addEventListener('change', updateSelectedInfo);
        updateSelectedInfo();
    }

    const container = document.getElementById('orderItemsContainer');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
});

function addToCart() {
    const productSelect = document.getElementById('selectedProduct');
    const quantityInput = document.getElementById('quantityInput');
    const quantityField = document.getElementById('quantityField');
    const form = document.getElementById('productForm');

    if (!productSelect || !quantityInput || !quantityField || !form) return;

    if (!productSelect.value) {
        alert('Please select a product.');
        return;
    }

    let qty = parseInt(quantityInput.value || '1', 10);
    if (isNaN(qty) || qty <= 0) {
        alert('Quantity must be at least 1.');
        return;
    }

    quantityField.value = qty;
    form.submit();
}

function quickAdd(qty) {
    const quantityInput = document.getElementById('quantityInput');
    if (!quantityInput) return;
    quantityInput.value = qty;
    addToCart();
}

document.addEventListener('DOMContentLoaded', function () {
    const productSelect = document.getElementById('selectedProduct');
    const priceSpan = document.getElementById('selectedProductPrice');
    const stockSpan = document.getElementById('selectedProductStock');

    function updateSelectedInfo() {
        if (!productSelect || !priceSpan || !stockSpan) return;
        const opt = productSelect.options[productSelect.selectedIndex];
        if (opt && opt.value) {
            priceSpan.textContent = opt.dataset.price || '0.00';
            stockSpan.textContent = opt.dataset.stock || '0';
        } else {
            priceSpan.textContent = '0.00';
            stockSpan.textContent = '0';
        }
    }

    if (productSelect) {
        productSelect.addEventListener('change', updateSelectedInfo);
        updateSelectedInfo();
    }

    const container = document.getElementById('orderItemsContainer');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
});

function addToCart() {
    const productSelect = document.getElementById('selectedProduct');
    const quantityInput = document.getElementById('quantityInput');
    const quantityField = document.getElementById('quantityField');
    const form = document.getElementById('productForm');

    if (!productSelect || !quantityInput || !quantityField || !form) return;

    if (!productSelect.value) {
        alert('Please select a product.');
        return;
    }

    let qty = parseInt(quantityInput.value || '1', 10);
    if (isNaN(qty) || qty <= 0) {
        alert('Quantity must be at least 1.');
        return;
    }

    quantityField.value = qty;
    form.submit();
}

function quickAdd(qty) {
    const quantityInput = document.getElementById('quantityInput');
    if (!quantityInput) return;
    quantityInput.value = qty;
    addToCart();
}
</script>
{% endblock %}