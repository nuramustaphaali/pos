{% extends 'core/base.html' %}
{% load static %}

{% block title %}Yesterday Summary - SwiftPOS{% endblock %}

{% block topbar_title %}
Yesterday Summary
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    <div class="swiftpos-toast-container">
        {% if messages %}
            {% for message in messages %}
                <div class="swiftpos-toast swiftpos-toast-{{ message.tags }}">
                    <div class="toast-icon">
                        {% if message.tags == 'success' %}
                            <i class="fas fa-check-circle"></i>
                        {% elif message.tags == 'error' or message.tags == 'danger' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% elif message.tags == 'warning' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% else %}
                            <i class="fas fa-info-circle"></i>
                        {% endif %}
                    </div>
                    <div class="toast-text">
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Top summary cards -->
    <div class="row g-3 mb-3">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-muted">Total Revenue</div>
                        <div class="price mt-1">₦{{ summary.total_revenue|floatformat:2 }}</div>
                        <div class="small text-muted">
                            {{ summary.total_transactions }} transaction{{ summary.total_transactions|pluralize }}
                        </div>
                    </div>
                    <div class="rounded-circle d-flex align-items-center justify-content-center"
                         style="width:42px;height:42px;background:rgba(79,70,229,.08);color:var(--sp-primary);">
                        <i class="fas fa-coins"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-muted">Cash</div>
                        <div class="h5 mb-1">₦{{ summary.cash_revenue|floatformat:2 }}</div>
                        <div class="small text-muted">
                            {{ summary.cash_transactions }} cash txn
                        </div>
                    </div>
                    <div class="rounded-circle d-flex align-items-center justify-content-center"
                         style="width:42px;height:42px;background:rgba(22,163,74,.12);color:var(--sp-success);">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-muted">POS / Card</div>
                        <div class="h5 mb-1">₦{{ summary.pos_revenue|floatformat:2 }}</div>
                        <div class="small text-muted">
                            {{ summary.pos_transactions }} POS txn
                        </div>
                    </div>
                    <div class="rounded-circle d-flex align-items-center justify-content-center"
                         style="width:42px;height:42px;background:rgba(96,165,250,.12);color:var(--sp-primary-soft);">
                        <i class="fas fa-credit-card"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-muted">Transfer + Mobile</div>
                        <div class="h6 mb-1">₦{{ summary.transfer_revenue|floatformat:2 }}</div>
                        <div class="small text-muted">
                            Mobile: ₦{{ summary.mobile_money_revenue|floatformat:2 }}
                        </div>
                    </div>
                    <div class="rounded-circle d-flex align-items-center justify-content-center"
                         style="width:42px;height:42px;background:rgba(59,130,246,.12);color:var(--sp-info);">
                        <i class="fas fa-university"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unusual transactions -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0 d-flex align-items-center gap-2">
                <i class="fas fa-triangle-exclamation"></i> Unusual Transactions
            </h6>
            <span class="small text-muted">
                Orders above ₦{{ min_amount|floatformat:2 }} or flagged manually.
            </span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="font-size: 8px !important">
                <table class="table align-middle mb-0 table-hover" style="font-size: 8px !important">
                    <thead>
                    <tr>
                        <th>Order Details</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if unusual_transactions %}
                        {% for unusual in unusual_transactions %}
                            <tr>
                                <td>
                                    <div class="fw-semibold small">
                                        <a href="{% url 'sales:print_receipt' unusual.order.id %}" class="text-decoration-none text-primary">
                                            {{ unusual.order.order_number }}
                                        </a>
                                    </div>
                                    <div class="text-muted small">
                                        {{ unusual.order.created_at|date:"Y-m-d H:i" }}
                                    </div>
                                    <div class="small text-muted">
                                        Payment: {{ unusual.order.get_payment_method_display }}
                                    </div>
                                    <div class="small text-muted">
                                        Flagged By: {{ unusual.flagged_by|default:"-" }}
                                    </div>
                                </td>
                                <td>
                                    ₦{{ unusual.order.final_amount|floatformat:2 }}
                                </td>
                                <td>
                                    {% if unusual.resolved %}
                                        <span class="badge bg-success-subtle text-success border border-success-subtle">
                                            Resolved
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">
                                            Pending
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary">
                                        View Details
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted small py-3">
                                No unusual transactions flagged for yesterday.
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Yesterday orders list -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0 d-flex align-items-center gap-2">
                <i class="fas fa-list"></i> Yesterday Orders
            </h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print();">
                <i class="fas fa-print me-1"></i> Print
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="font-size: 10px !important">
                <table class="table align-middle mb-0 table-hover" style="font-size: 10px !important">
                    <thead>
                    <tr>
                        <th>Order Details</th>
                        <!--<th>Customer</th>-->
                        <th>Amount</th>
                        <th>Cashier</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if yesterday_orders %}
                        {% for order in yesterday_orders %}
                            <tr>
                               <td>
                                    <div class="fw-semibold small">
                                        <a href="{% url 'sales:print_receipt' order.id %}" class="text-decoration-none text-primary">
                                            {{ order.order_number }}
                                        </a>
                                    </div>
                                    <div class="text-muted small">
                                        {{ order.created_at|date:"Y-m-d H:i" }}
                                    </div>
                                    <div class="small text-muted">
                                        Payment: {{ order.get_payment_method_display }}
                                    </div>
                                </td>
                                <!--<td>-->
                                <!--    {{ order.customer_name|default:"Walk-in" }}-->
                                <!--</td>-->
                                <td class="text-end">
                                    ₦{{ order.final_amount|floatformat:2 }}
                                </td>
                                <td>
                                    {{ order.cashier }}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted small py-3">
                                No orders were found for yesterday.
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}